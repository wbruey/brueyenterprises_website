<!DOCTYPE html>
<html>

<head>
  <title>Meatball's Meatballs</title>
<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>
<script>
  //initalize firebase
  var config = {
    apiKey: "AIzaSyB1Nxa4A1ZISBjMgtTdHczNxrnCF7HZP0s",
    authDomain: "brutest-3228a.firebaseapp.com",
    databaseURL: "https://brutest-3228a.firebaseio.com",
    projectId: "brutest-3228a",
    storageBucket: "brutest-3228a.appspot.com",
    messagingSenderId: "1099500974553"
  };
  firebase.initializeApp(config);
  var database = firebase.database();

  // first ask a user for their permission to geo locate, if they say yes, continue
  if (navigator.geolocation) {
    // if user syas OK to geo location, then get their position and store it.
	navigator.geolocation.getCurrentPosition(storePosition);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }

  //store the users position
  function storePosition(position){
	//first determine which user number this is.
	firebase.database().ref('/meatball_finder/').once('value').then(function(snapshot) {
		//get user count from firebase.
		user_count = (snapshot.val() && snapshot.val().user_count) || 'unkown';
		//add one to the user_count.
		user_count = user_count+1;
		//publish the user count to webpage and the latitude and longitude.
		document.getElementById("user_count").innerHTML=user_count;
		var latitude=position.coords.latitude;
		var longitude=position.coords.longitude;
		document.getElementById("lat").innerHTML=latitude;
		document.getElementById("lon").innerHTML=longitude;
		
		//update the user_count to firebase. 
		var updates ={};
		updates['/meatball_finder/user_count']=user_count;
		firebase.database().ref().update(updates);			
		
		//write the new lat and lon to the user's spot in the database.
		var updates ={};
		updates['/meatball_finder/'+user_count+'/latitude']=latitude;
		updates['/meatball_finder/'+user_count+'/longitude']=longitude;
		firebase.database().ref().update(updates);			
		
		function httpGetAsync(theUrl, callback)
		{
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function() { 
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
					callback(xmlHttp.responseText);
			}
			xmlHttp.open("GET", theUrl, true); // true for asynchronous 
			xmlHttp.setRequestHeader('Access-Control-Allow-Credentials','true')
			xmlHttp.setRequestHeader('Authorization','Bearer 8ZenU1STmxat_twXqcd6wQ9IDKMwVv-UPZINBafEv6t1KPkZKoYk3pgqKDyQFDu692Hg1g_fLzmYLTkX3Pp1njdmsbGN883CTg498J3kC7EL7y217To4ShuIEYNfXHYx');
			xmlHttp.withCredentials=true;
			xmlHttp.send(null);
		}

		function display_response(the_response){
			console.log(the_response);
		}
		
		httpGetAsync('https://api.yelp.com/v3/businesses/search?term=meatballs&latitude=40.7106795&longitude=-74.0087278"&limit=1',display_response);
		
	});
	
  }
  
  

  
  


</script>


</head>


<body>

<body>

<h1>Talkin Meatballs Here</h1>
<p>I know what you're thinkin...where is the closest meatball shop right now?</p>
<p>We've helped a lot of folks find meatballs</p>
<p id="user_count"></p>
<p>...to be exact.</p>
<p>Here is your current location:</p>
<p>Latitude</p>
<p id="lat"></p>
<p>Longitude</p>
<p id="lon"></p>
<p>Here is the closest meatball shop to you right now.</p><p>


</p></body>
</body>
</html>

