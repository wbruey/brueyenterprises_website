<!DOCTYPE html>
<html>

<head>
  <title>Meatball's Meatballs</title>
<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>
<script>
  //initalize firebase
  var config = {
    apiKey: "AIzaSyB1Nxa4A1ZISBjMgtTdHczNxrnCF7HZP0s",
    authDomain: "brutest-3228a.firebaseapp.com",
    databaseURL: "https://brutest-3228a.firebaseio.com",
    projectId: "brutest-3228a",
    storageBucket: "brutest-3228a.appspot.com",
    messagingSenderId: "1099500974553"
  };
  firebase.initializeApp(config);
  var database = firebase.database();

  // first ask a user for their permission to geo locate, if they say yes, continue
  if (navigator.geolocation) {
    // if user syas OK to geo location, then get their position and store it.
	navigator.geolocation.getCurrentPosition(storePosition);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }

  //store the users position
  function storePosition(position){
	//first determine which user number this is.
	firebase.database().ref('/meatball_finder/').once('value').then(function(snapshot) {
		//get user count from firebase.
		user_count = (snapshot.val() && snapshot.val().user_count) || 'unkown';
		//add one to the user_count.
		user_count = user_count+1;
		//publish the user count to webpage and the latitude and longitude.
		document.getElementById("user_count").innerHTML=user_count;
		var latitude=position.coords.latitude;
		var longitude=position.coords.longitude;
		document.getElementById("lat").innerHTML=latitude;
		document.getElementById("lon").innerHTML=longitude;
		
		//update the user_count to firebase. 
		var updates ={};
		updates['/meatball_finder/user_count']=user_count;
		firebase.database().ref().update(updates);			
		
		//write the new lat and lon to the user's spot in the database.
		var updates ={};
		updates['/meatball_finder/'+user_count+'/latitude']=latitude;
		updates['/meatball_finder/'+user_count+'/longitude']=longitude;
		firebase.database().ref().update(updates);			
		
        //call the cloud function 
		function httpGetAsync(theURL,callback)
        {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() { 
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
					callback(xmlHttp.responseText);
			}
            xmlHttp.open("GET", theURL, true); // true for asynchronous
            xmlHttp.send(null);
            
        }

		function display_response(the_response){
			console.log(the_response);
		}
        
        //var latitude = 33.921477;
        //var longitude = -118.327;

        //var latitude = 40.11563;
        //var longitude = -76.337;
        
        httpGetAsync('https://us-central1-brutest-3228a.cloudfunctions.net/call_yelp?user_count='+user_count+'&latitude='+latitude+'&longitude='+longitude,display_response);


        var food_image=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/image_url');
        food_image.on('value',function(snapshot){
            document.getElementById("food_image").src=snapshot.val() || 'https://godshotspot.files.wordpress.com/2014/07/spotlight-battleofgods.jpg';
        });

        
        var restaurant_name=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/name');
        restaurant_name.on('value',function(snapshot){
			var this_name= snapshot.val() || 'Loading.... give it a minute.  Lots of meatballs to look through'
            document.getElementById("restaurant_name").innerHTML='<b>'+this_name+'</b>';
        });
        
        var distance=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/distance');
        distance.on('value',function(snapshot){
            document.getElementById("distance").innerHTML=parseFloat(snapshot.val())/1609.344;
        });
        
        var is_open=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/is_open');
        is_open.on('value',function(snapshot){
            document.getElementById("is_open").innerHTML=!snapshot.val();
        });
        
        //var the_link=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/url');
        //the_link.on('value',function(snapshot){
        //    console.log(snapshot.val());
        //    var link_url=
        //   document.getElementById("the_link").href=(snapshot.val() && snapshot.val().user_count) || 'www.google.com';
        //});
        
        //firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/url/').once('value').then(function(snapshot) {
        //    //var link_url = (snapshot.val() && snapshot.val().url) || 'www.google.com';
        //    var link_url = snapshot.val() || 'www.google.com';
        //    console.log(link_url);
        //    document.getElementById("map_link").href=link_url;
        //
        //});
        
        
        var url=firebase.database().ref('/meatball_finder/'+user_count+'/yelp/businesses/0/url');
        url.on('value',function(snapshot){
            //var link_url = (snapshot.val() && snapshot.val().url) || 'www.google.com';
            var link_url = snapshot.val() || '';
            console.log(link_url);
            document.getElementById("map_link").href=link_url;
			document.getElementById("map_link").innerHTML=link_url.length>2 ? 'Take Me There, Handsome!' : '';
        
        });
        
	});

  }
  
    
  


</script>


</head>


<body>

<body>

<h1>Talkin Meatballs Here</h1>
<p>I know what you're thinkin...where is the closest meatball shop right now?</p>
<p>We've helped a lot of folks find meatballs</p>
<p id="user_count"></p>
<p>...to be exact.</p>
<p>Here is your current location:</p>
<p>Latitude</p>
<p id="lat"></p>
<p>Longitude</p>
<p id="lon"></p>
<p>Here is the closest meatball shop to you right now:</p>
<p id="restaurant_name"> Loading.... give it a minute.  Lots of meatballs to look through  </p>
<p>But how many miles?</p>
<p id="distance"></p>
<p>Open right now tho?</p>
<p id="is_open"></p><br>
<a id="map_link" href="www.google.com"></a><br><br><br>
<img id="food_image" src="https://godshotspot.files.wordpress.com/2014/07/spotlight-battleofgods.jpg" alt="Hmmmm Meatballs">


</p></body>
</body>
</html>

